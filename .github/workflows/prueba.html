<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comprobante - Descarga PDF (Blob)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { background:#f5f6f8; margin:0; padding:24px; display:flex; justify-content:center; }
    .card {
      width: 420px; background:#fff; border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .header { padding:18px 18px 10px; display:flex; align-items:center; gap:12px; }
    .check {
      width:44px; height:44px; border-radius:999px; background:#19c37d; display:grid; place-items:center;
      color:#fff; font-weight:800; font-size:22px;
    }
    .title { margin:0; font-size:18px; font-weight:750; }
    .sub { margin:4px 0 0; color:#667085; font-size:13px; }
    .amount {
      background:#111; color:#fff; padding:12px 18px; font-weight:700; display:flex; justify-content:space-between;
    }
    .rows { padding:14px 18px 18px; }
    .row { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eef0f4; gap:12px; }
    .row:last-child { border-bottom:none; }
    .k { color:#667085; font-size:13px; }
    .v { font-weight:650; font-size:13px; text-align:right; }
    .actions { padding:14px 18px 18px; display:grid; gap:10px; }
    button {
      border:0; border-radius:12px; padding:12px 14px; font-weight:750; cursor:pointer;
    }
    .primary { background:#f2c300; }
    .ghost { background:#eef0f4; }
    .hint { padding:0 18px 18px; color:#667085; font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }
  </style>
</head>

<body>
  <div class="card" id="receipt">
    <div class="header">
      <div class="check">✓</div>
      <div>
        <p class="title">¡El pago fue exitoso!</p>
        <p class="sub">Bancolombia • Transferencia</p>
      </div>
    </div>

    <div class="amount">
      <span>Total pagado</span>
      <span id="total">$8,000.00</span>
    </div>

    <div class="rows">
      <div class="row"><div class="k">Número de comprobante</div><div class="v" id="receiptId">D332B22H</div></div>
      <div class="row"><div class="k">Fecha y hora</div><div class="v" id="datetime">21 enero 2026 08:31:50</div></div>
      <div class="row"><div class="k">Referencia del producto</div><div class="v mono" id="reference">O2026012109301301060000</div></div>
      <div class="row"><div class="k">Producto origen</div><div class="v" id="product">Cuenta de ahorros</div></div>
      <div class="row"><div class="k">Cuenta</div><div class="v" id="account">*4033</div></div>
      <div class="row"><div class="k">Comercio</div><div class="v" id="merchant">Tigo2 SandBox</div></div>
      <div class="row"><div class="k">Costo transacción</div><div class="v" id="fee">$0 COP</div></div>
    </div>

    <div class="actions">
      <button class="primary" id="btnDownload">Descargar comprobante</button>
      <button class="ghost" id="btnBack">Regresar al comercio</button>
    </div>

    <div class="hint">
      Este demo replica la lógica: <span class="mono">Blob → URL.createObjectURL → &lt;a download&gt; → click</span>
    </div>
  </div>

  <script>
    // --- 1) "saveAs" estilo FileSaver (lo que viste en el código minificado)
    function saveAsBlob(blob, filename) {
      // Compat IE/Edge legacy
      if (window.navigator && window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveOrOpenBlob(blob, filename);
        return;
      }

      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);

      a.href = url;
      a.download = filename;
      a.rel = "noopener";
      a.target = "_blank";

      // Dispara el click programáticamente (igual que dispatchEvent MouseEvent("click"))
      a.click();

      // Limpieza de memoria (como setTimeout + revokeObjectURL)
      setTimeout(() => URL.revokeObjectURL(url), 30_000);
    }

    // --- 2) Generar un PDF "mínimo" (sin librerías) para demostrar el flujo
    // Esto crea un PDF básico con texto (suele abrir/descargar bien en Chrome/Edge/Firefox).
    function buildMinimalPdfBytes(lines) {
      // PDF mínimo: 1 página, fuente Helvetica, dibuja líneas de texto
      // (No es un generador completo; es suficiente para el demo)
      const safe = (s) => String(s).replace(/[()\\]/g, (m) => "\\" + m);

      const textOps = lines.map((t, i) => {
        const y = 760 - (i * 16);
        return `BT /F1 12 Tf 60 ${y} Td (${safe(t)}) Tj ET`;
      }).join("\n");

      const objects = [];
      objects.push(`1 0 obj << /Type /Catalog /Pages 2 0 R >> endobj`);
      objects.push(`2 0 obj << /Type /Pages /Count 1 /Kids [3 0 R] >> endobj`);
      objects.push(`3 0 obj << /Type /Page /Parent 2 0 R /MediaBox [0 0 595 842] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >> endobj`);
      const stream = `q\n${textOps}\nQ`;
      objects.push(`4 0 obj << /Length ${stream.length} >> stream\n${stream}\nendstream endobj`);
      objects.push(`5 0 obj << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> endobj`);

      let pdf = `%PDF-1.4\n`;
      const offsets = [0];
      for (const obj of objects) {
        offsets.push(pdf.length);
        pdf += obj + "\n";
      }

      const xrefStart = pdf.length;
      pdf += `xref\n0 ${objects.length + 1}\n`;
      pdf += `0000000000 65535 f \n`;
      for (let i = 1; i <= objects.length; i++) {
        const off = String(offsets[i]).padStart(10, "0");
        pdf += `${off} 00000 n \n`;
      }

      pdf += `trailer << /Size ${objects.length + 1} /Root 1 0 R >>\n`;
      pdf += `startxref\n${xrefStart}\n%%EOF`;

      return new TextEncoder().encode(pdf);
    }

    function getReceiptDataFromUI() {
      return {
        total: document.getElementById("total").textContent.trim(),
        receiptId: document.getElementById("receiptId").textContent.trim(),
        datetime: document.getElementById("datetime").textContent.trim(),
        reference: document.getElementById("reference").textContent.trim(),
        product: document.getElementById("product").textContent.trim(),
        account: document.getElementById("account").textContent.trim(),
        merchant: document.getElementById("merchant").textContent.trim(),
        fee: document.getElementById("fee").textContent.trim(),
      };
    }

    // --- 3) Click del botón (escenario real)
    document.getElementById("btnDownload").addEventListener("click", () => {
      const d = getReceiptDataFromUI();

      // En un escenario real, aquí podrías hacer:
      // fetch("/api/pdf").then(r => r.blob()).then(blob => saveAsBlob(blob, "comprobante.pdf"));
      // En este demo, generamos el PDF en front.
      const lines = [
        "COMPROBANTE DE PAGO",
        "----------------------------------------",
        `Total pagado: ${d.total}`,
        `Numero de comprobante: ${d.receiptId}`,
        `Fecha y hora: ${d.datetime}`,
        `Referencia: ${d.reference}`,
        `Producto origen: ${d.product}`,
        `Cuenta: ${d.account}`,
        `Comercio: ${d.merchant}`,
        `Costo transaccion: ${d.fee}`,
        "",
        "Este PDF fue generado en el navegador usando Blob + createObjectURL()."
      ];

      const pdfBytes = buildMinimalPdfBytes(lines);
      const blob = new Blob([pdfBytes], { type: "application/pdf" });

      saveAsBlob(blob, `Comprobante_Transferencia_Boton.pdf`);
    });

    document.getElementById("btnBack").addEventListener("click", () => {
      alert("Demo: aquí normalmente redireccionarías al comercio.");
    });
  </script>
</body>
</html>
